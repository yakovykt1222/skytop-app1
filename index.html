<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f4f4f7; color: #000; display: flex; flex-direction: column; align-items: center; padding: 20px 0; margin: 0; }
        .card { background: white; border-radius: 20px; width: 90%; max-width: 380px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; text-align: center; }
        .title { font-size: 13px; color: #8e8e93; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px; }
        .timer { font-size: 32px; font-weight: 800; color: #007aff; margin-bottom: 20px; }
        
        /* –°–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—É–º–º—ã */
        .amounts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .opt-btn { background: #f2f2f7; border: 2px solid transparent; border-radius: 12px; padding: 12px 5px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .opt-btn.selected { border-color: #007aff; background: #fff; color: #007aff; transform: scale(1.05); }

        /* –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
        .btn-confirm { background: #007aff; color: white; border: none; border-radius: 14px; padding: 16px; width: 100%; font-size: 16px; font-weight: 600; cursor: pointer; display: none; }
        
        /* –†–µ—Ñ–µ—Ä–∞–ª–∫–∞ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */
        .ref-box { display: flex; gap: 10px; margin-top: 15px; }
        .btn-ref { flex: 1; background: #f2f2f7; color: #007aff; border: none; border-radius: 10px; padding: 12px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .instr-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .instr-link { background: #fff; border: 1px solid #e5e5ea; border-radius: 12px; padding: 10px; text-decoration: none; color: #000; font-size: 12px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="card">
        <div class="title">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –µ—â–µ:</div>
        <div class="timer" id="expire-timer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        
        <div class="title">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏—è:</div>
        <div class="amounts-grid">
            <button class="opt-btn" onclick="selectAmount(80, this)">1 –º–µ—Å<br><small>80 ‚ÇΩ</small></button>
            <button class="opt-btn" onclick="selectAmount(160, this)">2 –º–µ—Å<br><small>160 ‚ÇΩ</small></button>
            <button class="opt-btn" onclick="selectAmount(240, this)">3 –º–µ—Å<br><small>240 ‚ÇΩ</small></button>
            <button class="opt-btn" onclick="selectAmount(320, this)">4 –º–µ—Å<br><small>320 ‚ÇΩ</small></button>
            <button class="opt-btn" onclick="selectAmount(400, this)">5 –º–µ—Å<br><small>400 ‚ÇΩ</small></button>
            <button class="opt-btn" onclick="selectAmount(480, this)">6 –º–µ—Å<br><small>480 ‚ÇΩ</small></button>
            <button class="opt-btn" onclick="selectAmount(560, this)">7 –º–µ—Å<br><small>560 ‚ÇΩ</small></button>
            <button class="opt-btn" onclick="selectAmount(640, this)">8 –º–µ—Å<br><small>640 ‚ÇΩ</small></button>
            <button class="opt-btn" onclick="selectAmount(720, this)">9 –º–µ—Å<br><small>720 ‚ÇΩ</small></button>
        </div>

        <button class="btn-confirm" id="confirm-btn" onclick="startPayment()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å</button>
    </div>

    <div class="card">
        <div class="title">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ ‚Äî –ø–æ–ª—É—á–∏ +7 –¥–Ω–µ–π</div>
        <div class="ref-box">
            <button class="btn-ref" onclick="copyRef()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn-ref" onclick="shareRef()">üîó –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div class="card">
        <div class="title">–í–∏–¥–µ–æ–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
        <div class="instr-grid">
            <a href="https://t.me/+jMnq2kQHuKs0MDZi" class="instr-link">iOS</a>
            <a href="https://t.me/+jMnq2kQHuKs0MDZi" class="instr-link">Android</a>
            <a href="https://t.me/+jMnq2kQHuKs0MDZi" class="instr-link">Windows</a>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe.user.id;
        
        // –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò –≠–¢–û –ü–†–ò –ö–ê–ñ–î–û–ú –ó–ê–ü–£–°–ö–ï NGROK
        const NGROK_URL = 'https://undepressible-candie-infinitival.ngrok-free.dev'; 

        let selectedAmount = 0;

        function selectAmount(amount, el) {
            selectedAmount = amount;
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
            document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é
            el.classList.add('selected');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const confirmBtn = document.getElementById('confirm-btn');
            confirmBtn.style.display = 'block';
            confirmBtn.innerText = `–û–ø–ª–∞—Ç–∏—Ç—å ${amount} ‚ÇΩ (–°–ë–ü/–ö–∞—Ä—Ç–∞)`;
        }

        async function startPayment() {
            const btn = document.getElementById('confirm-btn');
            btn.disabled = true;
            btn.innerText = "–°–æ–∑–¥–∞–µ–º —Å—á–µ—Ç...";

            try {
                const res = await fetch(`${NGROK_URL}/create-payment`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ amount: selectedAmount, user_id: userId })
                });
                const data = await res.json();
                if (data.link) {
                    tg.openLink(data.link);
                } else {
                    alert("–û—à–∏–±–∫–∞: " + data.error);
                }
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
            } finally {
                btn.disabled = false;
                btn.innerText = `–û–ø–ª–∞—Ç–∏—Ç—å ${selectedAmount} ‚ÇΩ (–°–ë–ü/–ö–∞—Ä—Ç–∞)`;
            }
        }

        function copyRef() {
            const link = `https://t.me/skytopvpnbot?start=${userId}`;
            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            tg.showAlert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—ë –¥—Ä—É–≥—É.");
        }

        function shareRef() {
            const link = `https://t.me/skytopvpnbot?start=${userId}`;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=–õ–æ–≤–∏ –∫—Ä—É—Ç–æ–π VPN! –ü–æ–¥–ø–∏—Å–∫–∞ –≤—Å–µ–≥–æ 80—Ä.`);
        }

        async function updateTimer() {
            try {
                const res = await fetch(`${NGROK_URL}/get-status?user_id=${userId}`);
                const data = await res.json();
                document.getElementById('expire-timer').innerText = data.time_left;
            } catch (e) { document.getElementById('expire-timer').innerText = "–û—à–∏–±–∫–∞"; }
        }
        updateTimer();
        setInterval(updateTimer, 10000); // –û–±–Ω–æ–≤–ª—è—Ç—å —Ä–∞–∑ –≤ 10 —Å–µ–∫
    </script>
</body>
</html>
