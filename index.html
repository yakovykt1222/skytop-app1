<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script> 
    <style>
        :root {
            --main-blue: #007aff;
            --bg-color: #f4f4f7;
            --card-bg: #ffffff;
            --text-gray: #8e8e93;
            --success-green: #34c759;
            --error-red: #ff3b30;
        }

        body { 
            font-family: -apple-system, sans-serif; 
            background-color: var(--bg-color); 
            color: #000; 
            margin: 0; 
            padding-bottom: 30px; 
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--card-bg);
            border-bottom: 1px solid #e5e5ea;
        }

        .logo { font-weight: 800; font-size: 18px; color: var(--main-blue); }

        .container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-top: 15px; 
        }

        .card { 
            background: var(--card-bg); 
            border-radius: 20px; 
            width: 92%; 
            max-width: 400px; 
            padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            margin-bottom: 15px; 
            text-align: center; 
        }

        .title { 
            font-size: 11px; 
            color: var(--text-gray); 
            font-weight: 600; 
            text-transform: uppercase; 
            margin-bottom: 10px; 
        }

        .status-text { 
            font-size: 22px; 
            font-weight: 800; 
            margin-bottom: 5px; 
        }

        .expire-date { 
            font-size: 14px; 
            color: var(--text-gray); 
            margin-bottom: 20px; 
        }

        .key-box {
            display:none;
            background:#f2f2f7;
            padding:12px;
            border-radius:12px;
            font-size:12px;
            word-break:break-all;
            margin-bottom:10px;
        }

        .btn-ref { 
            flex: 1; 
            background: #f2f2f7; 
            color: var(--main-blue); 
            border: none; 
            border-radius: 10px; 
            padding: 12px; 
            font-size: 13px; 
            font-weight: 600; 
            cursor: pointer; 
        }

        .btn-primary {
            width:100%;
            background: var(--main-blue);
            color:#fff;
            border:none;
            border-radius:14px;
            padding:14px;
            font-size:15px;
            font-weight:700;
            cursor:pointer;
            margin-top:10px;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">SkyTop VPN</div>
</div>


<div class="container">
        <div class="card">
            <div class="title">–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –µ—â–µ:</div>
            <div id="expire-timer" class="timer">...</div>
            
            <div class="title">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</div>
            <div class="amounts-grid">
                <button class="opt-btn" onclick="selectPrice(80, this)">80 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(160, this)">160 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(240, this)">240 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(320, this)">320 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(400, this)">400 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(480, this)">480 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(560, this)">560 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(640, this)">640 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(720, this)">720 ‚ÇΩ</button>
            </div>
            <button class="btn-confirm" id="confirm-pay-btn" onclick="processPayment()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å</button>
        </div>


    
<div class="container">

    <!-- –°–¢–ê–¢–£–° -->
    <div class="card">
        <div class="title">–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞</div>
        <div id="sub-status" class="status-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="sub-date" class="expire-date">–ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
        <button id="pay-btn" class="btn-primary" style="display:none;">
            üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        </button>
    </div>

    <!-- –ö–õ–Æ–ß -->
    <div class="card">
        <div class="title">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</div>
        <div class="amounts-grid">
        ...
        </div>
        <button class="btn-confirm" id="confirm-pay-btn" onclick="processPayment()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å</button>
    </div>
        
        <div class="title">–í–∞—à VPN –∫–ª—é—á</div>

        <div id="key-status" style="font-size:13px;color:#8e8e93;margin-bottom:10px;">
            –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É...
        </div>

        <div id="key-box" class="key-box">
            ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
        </div>

        <div style="display:flex;gap:8px;">
            <button class="btn-ref" onclick="toggleKey()" id="toggle-key-btn" style="display:none;">
                üëÅ –ü–æ–∫–∞–∑–∞—Ç—å
            </button>

            <button class="btn-ref" onclick="openInApp()" id="open-app-btn" style="display:none;">
                üöÄ –û—Ç–∫—Ä—ã—Ç—å
            </button>
        </div>

        <button class="btn-primary" onclick="rotateKey()" id="rotate-btn" style="display:none;">
            üîÑ –°–º–µ–Ω–∏—Ç—å –∫–ª—é—á
        </button>
    </div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
console.log("USER ID:", userId);

const BASE_URL = "https://api.skytop.space";

let vpnKey = "";
let keyVisible = false;
let selectedPrice = 0;

// ===== –°–¢–ê–¢–£–° =====
async function updateStatus() {
    try {
        const res = await fetch(`${BASE_URL}/get-status?user_id=${userId}`);
        const data = await res.json();

        const statusEl = document.getElementById("sub-status");
        const dateEl = document.getElementById("sub-date");

        if (!statusEl || !dateEl) return;

        if (data.time_left && data.time_left !== "–ò—Å—Ç–µ–∫–ª–∞") {
            statusEl.innerText = "–ê–∫—Ç–∏–≤–Ω–∞";
            statusEl.style.color = "#34c759";
            dateEl.innerText = "–û—Å—Ç–∞–ª–æ—Å—å: " + data.time_left;
        } else {
            statusEl.innerText = "–ù–µ –∞–∫—Ç–∏–≤–Ω–∞";
            statusEl.style.color = "#ff3b30";
            dateEl.innerText = "–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å";
        }

    } catch (e) {
        console.log(e);
    }
}

// ===== –ö–õ–Æ–ß =====
async function loadKey() {
    try {
        const res = await fetch(`${BASE_URL}/get-status?user_id=${userId}`);
        const data = await res.json();

        const statusEl = document.getElementById("key-status");
        const toggleBtn = document.getElementById("toggle-key-btn");
        const openBtn = document.getElementById("open-app-btn");
        const rotateBtn = document.getElementById("rotate-btn");

        if (data.vpn_key_status === "–ê–∫—Ç–∏–≤–µ–Ω") {
            vpnKey = data.vpn_key; // —É–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ Python —ç—Ç–æ –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫
            statusEl.innerText = "–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞";
            statusEl.style.color = "#34c759";
            toggleBtn.style.display = "block";
            openBtn.style.display = "block";
            rotateBtn.style.display = "block";
        } else {
            statusEl.innerText = "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞";
            statusEl.style.color = "#ff3b30";
        }

    } catch (e) {
        console.log(e);
    }
}

function toggleKey() {
    const box = document.getElementById("key-box");
    const btn = document.getElementById("toggle-key-btn");

    if (!vpnKey) return;

    keyVisible = !keyVisible;

    if (keyVisible) {
        box.innerText = vpnKey;
        box.style.display = "block";
        btn.innerText = "üôà –°–∫—Ä—ã—Ç—å";
    } else {
        box.innerText = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
        btn.innerText = "üëÅ –ü–æ–∫–∞–∑–∞—Ç—å";
    }
}

function openInApp() {
    if (!vpnKey) return;
    tg.openLink(vpnKey);
}

// ===== –û–ü–õ–ê–¢–ê =====
function selectPrice(price, btn) {
    selectedPrice = price;

    document.querySelectorAll(".opt-btn").forEach(b => {
        b.classList.remove("active");
    });

    btn.classList.add("active");
    document.getElementById("confirm-pay-btn").style.display = "block";
}

function processPayment() {
    if (!selectedPrice) {
        tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É");
        return;
    }

    tg.sendData(JSON.stringify({
        action: "pay",
        amount: selectedPrice
    }));
}

async function pay(amount) {
    // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ Telegram WebApp API
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe.user.id;

    try {
        const response = await fetch('https://api.skytop.space/create-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                amount: amount,
                user_id: userId
            })
        });

        const data = await response.json();

        if (data.link) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –≤–Ω—É—Ç—Ä–∏ Telegram
            tg.openLink(data.link);
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞");
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞:", e);
        alert("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
    }
}


    
// ===== –°–ú–ï–ù–ê –ö–õ–Æ–ß–ê =====
async function rotateKey() {
    if (!userId) return;

    const btn = document.getElementById("rotate-btn");
    btn.innerText = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
    btn.disabled = true;

    try {
        const res = await fetch(`${BASE_URL}/rotate-key?user_id=${userId}`, {
            method: "POST"
        });

        if (res.ok) {
            const data = await res.json(); // –°—Ä–∞–∑—É –ø–∞—Ä—Å–∏–º JSON
            
            if (data.success || data.new_key) {
                vpnKey = data.new_key; // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                
                // –ï—Å–ª–∏ –ø–ª–∞—à–∫–∞ —Å –∫–ª—é—á–æ–º –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –≤ –Ω–µ–π —Ç–µ–∫—Å—Ç
                const box = document.getElementById("key-box");
                if (keyVisible) {
                    box.innerText = vpnKey;
                }

                tg.showAlert("‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å (–¥–∞—Ç—É), —á—Ç–æ–±—ã –≤—Å—ë –±—ã–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                await updateStatus(); 
            }
        } else {
            tg.showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏");
        }

    } catch (e) {
        console.error("FETCH ERROR:", e);
        tg.showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
    } finally {
        btn.innerText = "üîÑ –°–º–µ–Ω–∏—Ç—å –∫–ª—é—á";
        btn.disabled = false;
    }
}







    
// ===== –ó–ê–ü–£–°–ö =====
updateStatus();
loadKey();
</script>







