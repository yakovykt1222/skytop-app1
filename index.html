<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script> 
    <style>
        :root {
            --main-blue: #007aff;
            --bg-color: #f4f4f7;
            --card-bg: #ffffff;
            --text-gray: #8e8e93;
            --success-green: #34c759;
            --error-red: #ff3b30;
        }

        body { 
            font-family: -apple-system, sans-serif; 
            background-color: var(--bg-color); 
            color: #000; 
            margin: 0; 
            padding-bottom: 30px; 
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--card-bg);
            border-bottom: 1px solid #e5e5ea;
        }

        .logo { font-weight: 800; font-size: 18px; color: var(--main-blue); }

        .container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-top: 15px; 
        }

        .card { 
            background: var(--card-bg); 
            border-radius: 20px; 
            width: auto%; 
            max-width: 400px; 
            padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            margin-bottom: 15px; 
            text-align: center; 
        }

        .title { 
            font-size: 11px; 
            color: var(--text-gray); 
            font-weight: 600; 
            text-transform: uppercase; 
            margin-bottom: 10px; 
        }

        .status-text { 
            font-size: 22px; 
            font-weight: 800; 
            margin-bottom: 5px; 
        }

        .expire-date { 
            font-size: 14px; 
            color: var(--text-gray); 
            margin-bottom: 20px; 
        }

        .key-box {
            display:none;
            background:#f2f2f7;
            padding:12px;
            border-radius:12px;
            font-size:12px;
            word-break:break-all;
            margin-bottom:10px;
        }

        .btn-ref { 
            flex: 1; 
            background: #f2f2f7; 
            color: var(--main-blue); 
            border: none; 
            border-radius: 10px; 
            padding: 12px; 
            font-size: 13px; 
            font-weight: 600; 
            cursor: pointer; 
        }

        .btn-primary {
            width:auto%;
            background: var(--main-blue);
            color:#fff;
            border:none;
            border-radius:14px;
            padding:14px;
            font-size:15px;
            font-weight:700;
            cursor:pointer;
            margin-top:10px;
        }
        .key-card {
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
        }

        .key-card:active {
            transform: scale(0.98); /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
        }

        .key-display {
            background: #f4f4f4;
            padding: 12px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all; /* –ß—Ç–æ–±—ã –¥–ª–∏–Ω–Ω—ã–π –∫–ª—é—á –Ω–µ –≤—ã–ª–µ–∑–∞–ª –∑–∞ –∫—Ä–∞—è */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-icon {
            margin-left: 10px;
            font-size: 16px;
        } 

        
 /* –°–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—É–º–º—ã */
        .amounts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .opt-btn { background: #f2f2f7; border: 2px solid transparent; border-radius: 12px; padding: 12px 5px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
        .opt-btn.active { border-color: var(--main-blue); background: #fff; color: var(--main-blue); box-shadow: 0 4px 10px rgba(0,122,255,0.1); }

        .btn-confirm { background: var(--main-blue); color: white; border: none; border-radius: 14px; padding: 18px; width: 100%; font-size: 16px; font-weight: 700; cursor: pointer; display: none; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .ref-box { display: flex; gap: 10px; margin-top: 15px; }
        .btn-ref { flex: 1; background: #f2f2f7; color: var(--main-blue); border: none; border-radius: 10px; padding: 12px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .instr-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .instr-link { background: #fff; border: 1px solid #e5e5ea; border-radius: 12px; padding: 10px; text-decoration: none; color: #000; font-size: 12px; font-weight: 600; }

   
    </style>
</head>
<body>

<div class="container">
    <!-- –°–¢–ê–¢–£–° -->
    <div class="card">
        <div class="title">–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞</div>
        <div id="sub-status" class="status-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="sub-date" class="expire-date">–ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
        <button id="pay-btn" class="btn-primary" style="display:none;">
            üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
        </button>
    </div>

    <!-- –ö–õ–Æ–ß -->
    <div class="card">
        <div class="title">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</div>
            <div class="amounts-grid">
                <button class="opt-btn" onclick="selectPrice(80, this)">80 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(160, this)">160 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(240, this)">240 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(320, this)">320 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(400, this)">400 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(480, this)">480 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(560, this)">560 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(640, this)">640 ‚ÇΩ</button>
                <button class="opt-btn" onclick="selectPrice(720, this)">720 ‚ÇΩ</button>
            </div>
            <button class="btn-confirm" id="confirm-pay-btn" onclick="processPayment()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å</button>
        </div>
        
        <div class="title">–í–∞—à VPN –∫–ª—é—á</div>

        <div id="key-status" style="font-size:13px;color:#8e8e93;margin-bottom:10px;">
            –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É...
        </div>

        <div id="key-box" class="key-box">
            ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
        </div>

        <div style="display:flex;gap:8px;">
            <button class="btn-ref" onclick="toggleKey()" id="toggle-key-btn" style="display:none;">
                üëÅ –ü–æ–∫–∞–∑–∞—Ç—å
            </button>

            <button class="btn-ref" onclick="openInApp()" id="open-app-btn" style="display:none;">
                üöÄ –û—Ç–∫—Ä—ã—Ç—å
            </button>
        </div>

        <button class="btn-primary" onclick="rotateKey()" id="rotate-btn" style="display:none;">
            üîÑ –°–º–µ–Ω–∏—Ç—å –∫–ª—é—á
        </button>
    </div>
        <div class="card">
            <div class="title">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ (+7 –¥–Ω–µ–π)</div>
            <div class="ref-box">
                <button class="btn-ref" onclick="copyReferralLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn-ref" onclick="shareReferralLink()">üîó –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
        <div class="card key-card" onclick="copyKey()">
            <div class="title">–í–∞—à –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞</div>
            <div class="key-display">
                <span id="vpn-key">vless://...–≤–∞—à_–∫–ª—é—á...</span>
                <span class="copy-icon">üìã</span>
           </div>
           <div id="copy-status" style="display:none; font-size: 10px; color: #4caf50; margin-top: 5px;">
               –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!
           </div>
        </div>
 

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
console.log("USER ID:", userId);

const BASE_URL = "https://api.skytop.space";

let vpnKey = "";
let keyVisible = false;
let selectedPrice = 0;

// ===== –°–¢–ê–¢–£–° =====
async function updateStatus() {
    try {
        const res = await fetch(`${BASE_URL}/get-status?user_id=${userId}`);
        const data = await res.json();

        const statusEl = document.getElementById("sub-status");
        const dateEl = document.getElementById("sub-date");

        if (!statusEl || !dateEl) return;

        if (data.time_left && data.time_left !== "–ò—Å—Ç–µ–∫–ª–∞") {
            statusEl.innerText = "–ê–∫—Ç–∏–≤–Ω–∞";
            statusEl.style.color = "#34c759";
            dateEl.innerText = "–û—Å—Ç–∞–ª–æ—Å—å: " + data.time_left;
        } else {
            statusEl.innerText = "–ù–µ –∞–∫—Ç–∏–≤–Ω–∞";
            statusEl.style.color = "#ff3b30";
            dateEl.innerText = "–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å";
        }

    } catch (e) {
        console.log(e);
    }
}

// ===== –ö–õ–Æ–ß =====
async function loadKey() {
    try {
        const res = await fetch(`${BASE_URL}/get-status?user_id=${userId}`);
        const data = await res.json();

        const statusEl = document.getElementById("key-status");
        const toggleBtn = document.getElementById("toggle-key-btn");
        const openBtn = document.getElementById("open-app-btn");
        const rotateBtn = document.getElementById("rotate-btn");

        if (data.vpn_key_status === "–ê–∫—Ç–∏–≤–µ–Ω") {
            vpnKey = data.vpn_key; // —É–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ Python —ç—Ç–æ –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫
            statusEl.innerText = "–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞";
            statusEl.style.color = "#34c759";
            toggleBtn.style.display = "block";
            openBtn.style.display = "block";
            rotateBtn.style.display = "block";
        } else {
            statusEl.innerText = "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞";
            statusEl.style.color = "#ff3b30";
        }

    } catch (e) {
        console.log(e);
    }
}

function toggleKey() {
    const box = document.getElementById("key-box");
    const btn = document.getElementById("toggle-key-btn");

    if (!vpnKey) return;

    keyVisible = !keyVisible;

    if (keyVisible) {
        box.innerText = vpnKey;
        box.style.display = "block";
        btn.innerText = "üôà –°–∫—Ä—ã—Ç—å";
    } else {
        box.innerText = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
        btn.innerText = "üëÅ –ü–æ–∫–∞–∑–∞—Ç—å";
    }
}
function copyKey() {
    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—Å—Ç –∫–ª—é—á–∞
    const keyText = document.getElementById('vpn-key').innerText;

    // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    navigator.clipboard.writeText(keyText).then(() => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"
        const status = document.getElementById('copy-status');
        status.style.display = 'block';
        
        // –í–∏–±—Ä–∞—Ü–∏—è (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Telegram)
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }

        // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞–¥–ø–∏—Å—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            status.style.display = 'none';
        }, 2000);
    }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏: ', err);
    });
}
function openInApp() {
    if (!vpnKey) return;
    tg.openLink(vpnKey);
}

// ===== –û–ü–õ–ê–¢–ê =====
function selectPrice(price, btn) {
    selectedPrice = price;

    document.querySelectorAll(".opt-btn").forEach(b => {
        b.classList.remove("active");
    });

    btn.classList.add("active");
    document.getElementById("confirm-pay-btn").style.display = "block";
}

function processPayment() {
    if (!selectedPrice) {
        tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É");
        return;
    }

    tg.sendData(JSON.stringify({
        action: "pay",
        amount: selectedPrice
    }));
}


 // –í—ã–±–æ—Ä —Ü–µ–Ω—ã
        let chosenAmount = 0;
        function selectPrice(amount, element) {
            chosenAmount = amount;
            document.querySelectorAll('.opt-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            const payBtn = document.getElementById('confirm-pay-btn');
            payBtn.style.display = 'block';
            payBtn.innerText = `–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å ${amount} ‚ÇΩ`;
        }

        // –û–ø–ª–∞—Ç–∞
        async function processPayment() {
            const btn = document.getElementById('confirm-pay-btn');
            btn.disabled = true;
            btn.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–Ω–∫—É...";
            try {
                const response = await fetch(`${BASE_URL}/create-payment`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ amount: chosenAmount, user_id: userId })
                });
                const result = await response.json();
                if (result.link) {
                    tg.openLink(result.link);
                } else {
                    tg.showAlert("–û—à–∏–±–∫–∞: " + result.error);
                }
            } catch (err) {
                tg.showAlert("–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.");
            } finally {
                btn.disabled = false;
                btn.innerText = `–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å ${chosenAmount} ‚ÇΩ`;
            }
        }

    

    
// ===== –°–ú–ï–ù–ê –ö–õ–Æ–ß–ê =====
async function rotateKey() {
    if (!userId) return;

    const btn = document.getElementById("rotate-btn");
    btn.innerText = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
    btn.disabled = true;

    try {
        const res = await fetch(`${BASE_URL}/rotate-key?user_id=${userId}`, {
            method: "POST"
        });

        if (res.ok) {
            const data = await res.json(); // –°—Ä–∞–∑—É –ø–∞—Ä—Å–∏–º JSON
            
            if (data.success || data.new_key) {
                vpnKey = data.new_key; // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                
                // –ï—Å–ª–∏ –ø–ª–∞—à–∫–∞ —Å –∫–ª—é—á–æ–º –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –≤ –Ω–µ–π —Ç–µ–∫—Å—Ç
                const box = document.getElementById("key-box");
                if (keyVisible) {
                    box.innerText = vpnKey;
                }

                tg.showAlert("‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å (–¥–∞—Ç—É), —á—Ç–æ–±—ã –≤—Å—ë –±—ã–ª–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                await updateStatus(); 
            }
        } else {
            tg.showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏");
        }

    } catch (e) {
        console.error("FETCH ERROR:", e);
        tg.showAlert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
    } finally {
        btn.innerText = "üîÑ –°–º–µ–Ω–∏—Ç—å –∫–ª—é—á";
        btn.disabled = false;
    }
}



  // –†–µ—Ñ–µ—Ä–∞–ª–∫–∞
        function copyReferralLink() {
            const link = `https://t.me/skytopvpnbot?start=${userId}`;
            const el = document.createElement('textarea');
            el.value = link;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            tg.showAlert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
        }

        function shareReferralLink() {
            const link = `https://t.me/skytopvpnbot?start=${userId}`;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=–õ–æ–≤–∏ –∫—Ä—É—Ç–æ–π VPN! –ü–æ–¥–ø–∏—Å–∫–∞ –≤—Å–µ–≥–æ 80—Ä.`);
        }




    
// ===== –ó–ê–ü–£–°–ö =====
updateStatus();
loadKey();
</script>

















